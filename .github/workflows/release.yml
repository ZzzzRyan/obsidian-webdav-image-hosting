name: Release Obsidian Plugin

permissions:
  contents: write

on:
  push:
    tags:
      - "*.*.*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²ï¼ŒåŒ…æ‹¬æ‰€æœ‰ tags

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # ä½ çš„ devDependencies é‡Œæ˜¯ TypeScript 4.7 / Node types 16.11ï¼Œ
          # ç”¨ Node 18/20 éƒ½èƒ½è·‘ã€‚è¿™é‡Œé€‰æ‹© 18ï¼Œå…¼å®¹å¥½ä¸€ç‚¹ã€‚
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build plugin
        run: npm run build

      - name: Package plugin files
        run: |
          ls -lah

          # ç¡®ä¿ main.js / manifest.json å­˜åœ¨
          if [ ! -f main.js ]; then
            echo "main.js not found in repository root after build!"
            exit 1
          fi

          if [ ! -f manifest.json ]; then
            echo "manifest.json not found in repository root!"
            exit 1
          fi

          # styles.css å¯é€‰
          if [ -f styles.css ]; then
            zip obsidian-webdav-image-hosting.zip main.js manifest.json styles.css
          else
            echo "styles.css not found, packaging only main.js and manifest.json"
            zip obsidian-webdav-image-hosting.zip main.js manifest.json
          fi

      - name: Generate Release Notes with AI
        id: generate_notes
        run: |
          # è·å–å½“å‰ tag
          CURRENT_TAG="${{ github.ref_name }}"

          # è·å–æ‰€æœ‰ tags å¹¶æ’åºï¼Œæ‰¾åˆ°ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -n1)

          # å¦‚æœ PREV_TAG ç­‰äº CURRENT_TAGï¼Œè¯´æ˜è¿™æ˜¯ç¬¬ä¸€ä¸ª tag
          if [ "$PREV_TAG" = "$CURRENT_TAG" ] || [ -z "$PREV_TAG" ]; then
            echo "First release, getting all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Getting commits from ${PREV_TAG} to ${CURRENT_TAG}"
            COMMITS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges)
          fi

          # å¦‚æœæ²¡æœ‰ commitsï¼Œå¯èƒ½æ˜¯å› ä¸ºåªæ‰“äº† tag æ²¡æœ‰æ–°æäº¤
          if [ -z "$COMMITS" ]; then
            echo "No new commits found, using current commit"
            COMMITS=$(git log -1 --pretty=format:"- %s (%h)")
          fi

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # é…ç½® AI æœåŠ¡å‚æ•°ï¼ˆæ”¯æŒè‡ªå®šä¹‰ï¼‰
          API_ENDPOINT="${{ secrets.RELEASE_AI_API_ENDPOINT }}"
          API_KEY="${{ secrets.RELEASE_AI_API_KEY }}"
          AI_MODEL="${{ secrets.RELEASE_AI_MODEL }}"

          # ä½¿ç”¨é»˜è®¤å€¼ï¼ˆOpenAIï¼‰å¦‚æœæœªé…ç½®
          if [ -z "$API_ENDPOINT" ]; then
            API_ENDPOINT="https://api.openai.com/v1/chat/completions"
          fi
          if [ -z "$AI_MODEL" ]; then
            AI_MODEL="gpt-4o-mini"
          fi

          echo "Using AI endpoint: $API_ENDPOINT"
          echo "Using AI model: $AI_MODEL"

          # è°ƒç”¨ AI API ç”Ÿæˆ release notes
          PROMPT="ä½ æ˜¯ Obsidian æ’ä»¶çš„æŠ€æœ¯æ–‡æ¡£æ’°å†™ä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹ Git commitsï¼Œç”Ÿæˆä¸“ä¸šçš„ Release Notesã€‚

è¦æ±‚ï¼š
1. å…ˆç”Ÿæˆä¸­æ–‡ç‰ˆæœ¬ï¼Œç„¶åç”Ÿæˆè‹±æ–‡ç‰ˆæœ¬ï¼Œç”¨åˆ†éš”ç¬¦ '---' éš”å¼€
2. åˆ†ç±»ï¼š
   - âœ¨ æ–°åŠŸèƒ½ (New Features)
   - ğŸš€ æ”¹è¿› (Improvements)
   - ğŸ› Bug ä¿®å¤ (Bug Fixes)
   - ğŸ“ æ–‡æ¡£ (Documentation)
   - ğŸ”§ é…ç½®/å·¥å…· (Configuration/Tooling)
3. æ¯æ¡è¦çªå‡ºç”¨æˆ·ä»·å€¼
4. æŠ€æœ¯æ€§ä¿®æ”¹è¦ç”¨é€šä¿—è¯­è¨€è§£é‡Š
5. æ ¼å¼ä¸º Markdownï¼Œé€‚åˆç›´æ¥å‘å¸ƒ
6. å¦‚æœæŸä¸ªåˆ†ç±»æ²¡æœ‰å†…å®¹ï¼Œå°±ä¸è¦æ˜¾ç¤ºè¯¥åˆ†ç±»

Commits:
$COMMITS

è¯·ç”Ÿæˆ Release Notesï¼ˆä¸­æ–‡ç‰ˆåœ¨å‰ï¼Œè‹±æ–‡ç‰ˆåœ¨åï¼Œç”¨ --- åˆ†éš”ï¼‰ï¼š"

          # æ£€æŸ¥æ˜¯å¦é…ç½®äº† API Key
          if [ -z "$API_KEY" ]; then
            echo "Warning: RELEASE_AI_API_KEY not configured, skipping AI generation"
            RELEASE_NOTES="## ğŸ‰ Release ${{ github.ref_name }}

### ğŸ“ Changes

$COMMITS"
          else
            RESPONSE=$(curl -s "$API_ENDPOINT" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d "{
                \"model\": \"$AI_MODEL\",
                \"messages\": [
                  {
                    \"role\": \"user\",
                    \"content\": $(echo "$PROMPT" | jq -Rs .)
                  }
                ],
                \"temperature\": 0.7,
                \"max_tokens\": 2000
              }")

            # æå– AI ç”Ÿæˆçš„å†…å®¹
            RELEASE_NOTES=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

            # å¦‚æœ AI è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ ¼å¼ï¼ˆä¸æ˜¾ç¤ºå¤±è´¥ä¿¡æ¯ï¼‰
            if [ -z "$RELEASE_NOTES" ] || [ "$RELEASE_NOTES" = "null" ]; then
              echo "AI generation failed, using fallback format"
              echo "API Response: $RESPONSE"
              RELEASE_NOTES="## ğŸ‰ Release ${{ github.ref_name }}

### ğŸ“ Changes

$COMMITS"
            fi
          fi

          # ä¿å­˜åˆ°è¾“å‡º
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.generate_notes.outputs.notes }}
          draft: false
          prerelease: false
          files: obsidian-webdav-image-hosting.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
